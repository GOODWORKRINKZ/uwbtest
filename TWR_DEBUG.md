# Анализ проблем TWR

## Проблемы из лога

### TAG отправляет но не получает ответ:
```
TAG [0x0B7C]: Отправка POLL запроса...
Данные: 41 88 4E FF FF FF FF 7C 0B 01 00 00 00 00 00 00
✓ Передача завершена успешно
✗ TAG: Нет ответа от ANCHOR
```

### Что происходит:
1. TAG отправляет POLL (код функции 0x01) на broadcast адрес FF FF
2. Передача успешна - модуль подтверждает отправку
3. НО - не получает ответ от ANCHOR

## Возможные причины

### 1. ANCHOR не принимает пакеты
- ANCHOR должен быть в режиме постоянного приема
- После инициализации вызвать `enableReceiver()`
- Проверить что приемник активен (регистр SYS_STATUS)

### 2. Недостаточные задержки
- После `sendData()` нужна задержка перед `enableReceiver()` - **минимум 5-10мс**
- После `enableReceiver()` нужна задержка перед `receiveData()` - **минимум 2-3мс**
- ANCHOR должен обрабатывать пакет и отправлять ответ - **5-10мс**

### 3. Broadcast не работает
- Попробовать конкретный адрес ANCHOR вместо FF FF
- Настроить PAN ID на обоих устройствах (сейчас FF FF)

### 4. ANCHOR не получает пакеты
- Нужно убедиться что ANCHOR действительно принимает пакеты
- Добавить отладку в режиме ANCHOR - показывать ВСЕ принятые пакеты

## Решение

### Изменения в коде (уже сделаны):

1. **TAG режим** - улучшен:
   - Увеличен интервал между измерениями до 1 сек
   - Добавлена явная активация приемника после отправки
   - Увеличено время ожидания ответа до 200мс
   - Добавлена отладочная информация о полученных данных

2. **ANCHOR режим** - улучшен:
   - Постоянный мониторинг входящих пакетов (без задержки)
   - Показывает ВСЕ полученные пакеты для отладки
   - Увеличено время ожидания FINAL
   - Добавлена реактивация приемника после ответа

### Проверьте на ANCHOR устройстве:
```
=== Инициализация ANCHOR режима ===
Мой адрес: 0x????
ANCHOR готов отвечать на запросы
Ожидание запросов от TAG...
```

Затем должны появляться сообщения о получении пакетов.

## Рекомендации для тестирования

### 1. Проверка ANCHOR
Запустите ANCHOR и убедитесь что он показывает:
- "ANCHOR готов отвечать на запросы"
- Если TAG передает, должны появляться:
  ```
  ANCHOR [0x????]: Получен пакет (16 байт)
  Данные: 41 88 ?? FF FF FF FF 7C 0B 01...
  ✓ ANCHOR: Это POLL от TAG [0x0B7C]
  ```

### 2. Проверка канала
Убедитесь что оба устройства на одном канале:
- По умолчанию используется канал 5
- Можно изменить через меню (опция 6)

### 3. Проверка адресов
- TAG адрес: 0x0B7C (из вашего лога)
- ANCHOR адрес: покажет при запуске
- Оба должны использовать PAN ID: 0xFFFF

### 4. Расстояние между модулями
- Начните с расстояния 0.5-2 метра
- UWB работает до ~50 метров в прямой видимости

## Дальнейшая отладка

Если проблема остается:

1. **Добавить дамп регистров SYS_STATUS** на обоих устройствах
2. **Проверить правильность SPI** - вызовите testCommunication()
3. **Проверить настройку канала** - убедитесь что канал одинаковый
4. **Попробовать другой канал** - канал 5 может быть зашумлен

## Структура пакета TWR

```
Байт   Значение    Описание
0-1    41 88       Frame Control (тип кадра)
2      XX          Sequence Number (счетчик пакетов)
3-4    FF FF       PAN ID (broadcast)
5-6    FF FF       Destination Address (broadcast или адрес ANCHOR)
7-8    7C 0B       Source Address (0x0B7C - TAG)
9      01/02/03    Function Code (01=POLL, 02=RESPONSE, 03=FINAL)
10-15  00...       Payload (метки времени, данные)
```

## Следующие шаги

1. Загрузите обновленный код на оба устройства
2. Запустите ANCHOR (команда 'a')
3. Запустите TAG (команда 't') на другом устройстве
4. Наблюдайте логи на обоих устройствах
5. Если ANCHOR не показывает входящие пакеты - проблема в приеме или канале
6. Если ANCHOR показывает пакеты но TAG не получает ответ - проблема в ответе ANCHOR
