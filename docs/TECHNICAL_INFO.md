# Техническая информация о DWM1000

## Обзор модуля

DWM1000 - это модуль Ultra-Wideband (UWB) от компании Qorvo (ранее Decawave), основанный на чипе DW1000.

### Основные характеристики

- **Частотный диапазон:** 3.5 - 6.5 GHz (UWB)
- **Каналы:** 1, 2, 3, 4, 5, 7 (6 каналов, канал 6 не используется в IEEE 802.15.4a)
- **Скорость передачи данных:** 110 kbps, 850 kbps, 6.8 Mbps
- **Дальность связи:** 
  - В помещении: до 50 м
  - На открытом пространстве: до 300 м
- **Точность измерения расстояния:** 10 см (в оптимальных условиях)
- **Напряжение питания:** 2.8 - 3.6 V (номинально 3.3V)
- **Ток потребления:**
  - Активный режим (TX): 120 mA
  - Активный режим (RX): 100 mA
  - Режим ожидания: 50 µA
- **Интерфейс:** SPI (до 20 MHz)
- **Температурный диапазон:** -40°C до +85°C

## Архитектура регистров

DWM1000 имеет сложную систему регистров для управления всеми аспектами работы.

### Ключевые регистры

| Адрес | Название | Размер | Описание |
|-------|----------|--------|----------|
| 0x00 | DEV_ID | 4 байта | ID устройства (должен быть 0xDECA0130) |
| 0x01 | EUI | 8 байт | Уникальный 64-битный идентификатор |
| 0x03 | PANADR | 4 байта | PAN ID и короткий адрес |
| 0x04 | SYS_CFG | 4 байта | Системная конфигурация |
| 0x0D | SYS_CTRL | 4 байта | Управление системой |
| 0x0F | SYS_STATUS | 5 байт | Статус системы |
| 0x09 | TX_BUFFER | до 1024 | Буфер передачи |
| 0x11 | RX_BUFFER | до 1024 | Буфер приема |
| 0x1F | CHAN_CTRL | 4 байта | Управление каналом |

## Режимы работы

### 1. Режим передачи (TX)

Последовательность действий:
1. Записать данные в TX_BUFFER
2. Настроить TX_FCTRL (размер кадра)
3. Установить бит TXSTRT в SYS_CTRL
4. Дождаться флага TXFRS в SYS_STATUS

### 2. Режим приема (RX)

Последовательность действий:
1. Установить бит RXENAB в SYS_CTRL
2. Дождаться флага RXFCG в SYS_STATUS (успешный прием)
3. Прочитать RX_FINFO для получения информации о кадре
4. Прочитать данные из RX_BUFFER
5. Очистить флаги статуса

### 3. Режим Two-Way Ranging (TWR)

TWR используется для точного измерения расстояния между двумя устройствами.

**Принцип работы:**

```
Устройство A                    Устройство B
(Инициатор)                     (Респондер)
    |                                |
    |------- Poll ------------------>|  t1
    |                                |  t2
    |<------ Response ---------------|  t3
    |                                |  t4
    |------- Final ----------------->|  t5
    |                                |  t6
```

**Формула расчета расстояния:**

```
tRound1 = t4 - t1  (время полного цикла на A)
tReply1 = t3 - t2  (время ответа на B)
tRound2 = t6 - t3  (время полного цикла на B)
tReply2 = t5 - t4  (время ответа на A)

tProp = (tRound1 * tRound2 - tReply1 * tReply2) / 
        (tRound1 + tRound2 + tReply1 + tReply2)

distance = tProp * c / 2

где c = скорость света (299792458 м/с)
```

## Настройка каналов

### Таблица каналов

| Канал | Центральная частота | Ширина полосы | Рекомендуемое использование |
|-------|-------------------|---------------|----------------------------|
| 1 | 3.5 GHz | 500 MHz | Помехозащищенность |
| 2 | 4.0 GHz | 500 MHz | Универсальный |
| 3 | 4.5 GHz | 500 MHz | Универсальный |
| 4 | 4.0 GHz | 900 MHz | Дальность |
| 5 | 6.5 GHz | 500 MHz | Точность |
| 7 | 6.5 GHz | 900 MHz | Скорость |

### Выбор канала

- **Канал 1-3:** Меньше помех от WiFi (2.4/5 GHz)
- **Канал 4:** Максимальная дальность за счет широкой полосы
- **Канал 5:** Оптимальная точность измерения
- **Канал 7:** Максимальная скорость передачи данных

## Конфигурация PRF (Pulse Repetition Frequency)

DWM1000 поддерживает два значения PRF:
- **16 MHz:** Меньшее энергопотребление, больше дальность
- **64 MHz:** Лучшая точность, меньше помех

## Конфигурация Preamble

Preamble - это преамбула, используемая для синхронизации:
- Длина: 64, 128, 256, 512, 1024, 2048, 4096 символов
- Короткая преамбула: быстрее, но менее надежна
- Длинная преамбула: медленнее, но надежнее на большой дистанции

## Управление мощностью передачи

DWM1000 позволяет настраивать мощность передачи через регистр TX_POWER.

**Диапазон:** От -41.3 dBm до +33.5 dBm

**Рекомендации:**
- Ближняя связь (<10 м): снизить мощность для экономии энергии
- Дальняя связь (>50 м): увеличить мощность
- В помещении: средняя мощность для избежания отражений

## Временные метки (Timestamps)

DWM1000 имеет внутренний счетчик времени с разрешением ~15.65 пс.

**Регистры временных меток:**
- TX_TIME: время отправки пакета
- RX_TIME: время приема пакета
- SYS_TIME: текущее системное время

Эти метки используются для точного измерения времени прохождения сигнала (Time of Flight).

## Калибровка антенны

Для точного измерения расстояния необходимо учитывать задержку в антенне:

```cpp
// Типичные значения задержки антенны (в единицах DW1000)
#define TX_ANT_DLY 16436  // Задержка TX антенны
#define RX_ANT_DLY 16436  // Задержка RX антенны
```

Эти значения записываются в регистры TX_ANTD и RX_ANTD.

## Частые проблемы и решения

### Проблема: Нестабильная связь

**Возможные причины:**
1. Слабый сигнал
2. Помехи от других устройств
3. Многолучевое распространение (отражения)

**Решения:**
1. Увеличить мощность передачи
2. Сменить канал
3. Использовать более длинную преамбулу
4. Добавить фильтрацию принятых пакетов

### Проблема: Низкая точность измерения расстояния

**Возможные причины:**
1. Неправильная калибровка антенны
2. Асинхронность часов устройств
3. Температурный дрейф

**Решения:**
1. Провести калибровку для конкретных антенн
2. Использовать Double-Sided TWR вместо Single-Sided
3. Применить температурную компенсацию

### Проблема: Большое энергопотребление

**Решения:**
1. Использовать Sniff Mode для периодического пробуждения
2. Снизить мощность передачи
3. Использовать PRF 16 MHz вместо 64 MHz
4. Увеличить интервал между измерениями

## SPI интерфейс

### Характеристики SPI

- **Режим:** Mode 0 (CPOL=0, CPHA=0)
- **Максимальная частота:** 20 MHz
- **Порядок битов:** MSB First
- **Размер слова:** 8 бит

### Формат транзакции

**Чтение регистра:**
```
Header: [REG_ADDR] [SUB_ADDR (опционально)]
Data:   [BYTE0] [BYTE1] ... [BYTEn]
```

**Запись регистра:**
```
Header: [0x80 | REG_ADDR] [SUB_ADDR (опционально)]
Data:   [BYTE0] [BYTE1] ... [BYTEn]
```

Бит 7 в адресе регистра определяет операцию:
- 0 = чтение
- 1 = запись

## Рекомендуемая литература

1. **DW1000 User Manual** - полное руководство по чипу
2. **APS006: Channel Effects on Communications Range and Time stamp Accuracy**
3. **APS011: Sources of Error in DW1000 Based Two-Way Ranging**
4. **APS013: DW1000 Antenna Delay Calibration**
5. **APS014: Antennae for DW1000 Based Products**

Все документы доступны на сайте Qorvo: https://www.qorvo.com/products/p/DW1000#documents

## Дополнительные функции

### LED индикация

DWM1000 имеет выходы для управления светодиодами:
- RXLED: индикация приема
- TXLED: индикация передачи

### GPIO

4 линии GPIO для пользовательских целей:
- Управление внешними устройствами
- Дополнительные индикаторы
- Синхронизация с внешними системами

### Внешняя синхронизация

Возможность синхронизации нескольких устройств через внешний сигнал для создания TDMA сетей.

## Совместимость со стандартами

- **IEEE 802.15.4-2011 UWB**
- **IEEE 802.15.4a-2007**

DWM1000 соответствует этим стандартам, что обеспечивает совместимость с другими UWB устройствами.
