# Примеры использования и тестирования

## Базовые тесты

### 1. Проверка подключения модуля

После загрузки прошивки первое, что нужно сделать - убедиться, что модуль подключен правильно.

**Ожидаемый вывод при успешном подключении:**
```
=== Инициализация модуля DWM1000 ===
Пины настроены:
  CS:   GPIO 7
  RST:  GPIO 10
  IRQ:  GPIO 2
  MOSI: GPIO 6
  MISO: GPIO 5
  SCK:  GPIO 4
SPI инициализирован (1 МГц, MODE0, MSB First)

Выполнение аппаратного сброса...
Сброс выполнен

Проверка связи с модулем...
Device ID: 0xDECA0130
✓ Модуль DWM1000 обнаружен успешно!
Скорость SPI увеличена до 8 МГц
```

**Если видите это - всё отлично! Модуль работает.**

### 2. Тест коммуникации (команда "2")

Этот тест проверяет надежность связи с модулем через SPI.

**Пример успешного теста:**
```
=== Тест коммуникации с модулем ===

Тест 1: Множественное чтение Device ID
  Попытка 1: 0xDECA0130 ✓
  Попытка 2: 0xDECA0130 ✓
  Попытка 3: 0xDECA0130 ✓
  Попытка 4: 0xDECA0130 ✓
  Попытка 5: 0xDECA0130 ✓

Тест 2: Запись/чтение регистра PANADR
  Оригинальные значения - PAN: 0xFFFF, Addr: 0xFFFF
  Записаны тестовые - PAN: 0xCAFE, Addr: 0xBEEF
  Прочитаны значения - PAN: 0xCAFE, Addr: 0xBEEF ✓
  Оригинальные значения восстановлены

Тест 3: Проверка линии IRQ
  Состояние IRQ: LOW

=== Результат тестов ===
✓ ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!
Модуль DWM1000 работает корректно.
```

## Тестирование передачи данных

Для проверки передачи данных нужно **два устройства** с модулями DWM1000.

### Устройство 1: Передатчик

1. Подключитесь к Serial Monitor
2. Нажмите `4` для включения режима передатчика
3. Каждые 2 секунды будут отправляться тестовые пакеты

**Пример вывода:**
```
>>> Выбран режим: Передатчик

=== Включение режима передатчика ===
Приемопередатчик выключен
Передатчик готов к работе

[1234 мс] Пакет #0:

=== Отправка данных (32 байт) ===
Данные: AA 55 00 00 04 D2 00 00 08 09 0A 0B 0C 0D 0E 0F ...
Передача начата...
✓ Передача завершена успешно

[3234 мс] Пакет #1:

=== Отправка данных (32 байт) ===
Данные: AA 55 00 00 0C A2 00 01 08 09 0A 0B 0C 0D 0E 0F ...
Передача начата...
✓ Передача завершена успешно
```

### Устройство 2: Приемник

1. Подключитесь к Serial Monitor
2. Нажмите `5` для включения режима приемника
3. Ожидайте приема данных от передатчика

**Пример вывода при успешном приеме:**
```
>>> Выбран режим: Приемник

=== Включение режима приемника ===
Приемопередатчик выключен
Приемник включен и готов к приему

=== Ожидание приема данных ===
✓ Данные приняты успешно
Размер принятых данных: 32 байт
Данные: AA 55 00 00 04 D2 00 00 08 09 0A 0B 0C 0D 0E 0F ...
  Временная метка: 1234 мс
  Номер пакета: 0
  Задержка: 15 мс
```

## Тестирование разных каналов

DWM1000 поддерживает работу на нескольких каналах. Можно использовать разные каналы для разных пар устройств.

**Доступные каналы:** 1, 2, 3, 4, 5, 7

### Смена канала:

1. Нажмите `7` в меню
2. Введите номер канала (например, `5`)
3. Модуль переключится на выбранный канал

**Важно:** Оба устройства (передатчик и приемник) должны быть на одном канале!

## Расшифровка формата пакета

Тестовый пакет имеет следующую структуру:

```
Байт 0-1:   Заголовок (0xAA 0x55)
Байт 2-5:   Временная метка (milliseconds)
Байт 6-7:   Номер пакета
Байт 8-31:  Тестовые данные (последовательность 08, 09, 0A, ...)
```

## Диагностика проблем

### Проблема: Модуль не обнаружен

**Симптомы:**
```
Device ID: 0x00000000
✗ ОШИБКА: Модуль DWM1000 не обнаружен
```

**Решение:**
1. Проверьте подключение проводов
2. Проверьте питание (должно быть 3.3V)
3. Убедитесь, что модуль не поврежден
4. Попробуйте выполнить сброс модуля (команда `8`)

### Проблема: Данные не передаются

**Симптомы:**
```
Передача начата...
✗ Таймаут передачи
```

**Решение:**
1. Проверьте подключение антенны
2. Выполните тест коммуникации (команда `2`)
3. Попробуйте перезагрузить устройство
4. Проверьте, что нет помех на выбранном канале

### Проблема: Данные не принимаются

**Симптомы:**
- Передатчик успешно отправляет
- Приемник не видит данных

**Решение:**
1. Убедитесь, что оба устройства на одном канале
2. Уменьшите расстояние между устройствами (начните с 1-2 метров)
3. Проверьте, что на приемнике включен режим приема (команда `5`)
4. Уберите металлические предметы и препятствия между устройствами

### Проблема: Нестабильная связь

**Симптомы:**
- Пакеты принимаются, но с пропусками
- Случайные ошибки CRC

**Решение:**
1. Улучшите качество соединения SPI (укоротите провода)
2. Добавьте развязывающие конденсаторы на питание
3. Попробуйте другой канал
4. Проверьте качество антенны

## Измерение характеристик

### Дальность связи

Проведите тест для определения максимальной дальности:

1. Разместите устройства близко (1 м)
2. Запустите передатчик и приемник
3. Постепенно увеличивайте расстояние
4. Фиксируйте расстояние, на котором пропадает связь

**Типичная дальность в помещении:** 30-50 метров
**Типичная дальность на открытом пространстве:** 100-200 метров

### Скорость передачи

Модуль поддерживает разные скорости:
- 110 kbps
- 850 kbps  
- 6.8 Mbps

В текущей реализации используются настройки по умолчанию.

## Следующие шаги

После успешного тестирования базовых функций можно:

1. **Реализовать измерение расстояния (TWR)**
   - Требует синхронизации между устройствами
   - Точность: 10-30 см

2. **Создать систему позиционирования**
   - Минимум 3 якоря (anchors)
   - 1 или более меток (tags)
   - Трилатерация для определения координат

3. **Добавить сетевой протокол**
   - Адресация устройств
   - Подтверждение доставки
   - Повторная передача при ошибках

4. **Оптимизировать энергопотребление**
   - Режимы сна
   - Снижение частоты передачи
   - Динамическое управление мощностью

## Полезные ссылки

- [DWM1000 Datasheet](https://www.qorvo.com/products/d/da008000)
- [DW1000 User Manual](https://www.qorvo.com/products/d/da007967)
- [Application Notes](https://www.qorvo.com/products/p/DW1000#documents)
